<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Music Player v8.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .version {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 10px;
            color: #666;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: normal;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .info-box {
            background: #2a2a2a;
            border: 1px solid #444;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .auth-section {
            background: #1a1a1a;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .search-section {
            background: #1a1a1a;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid #333;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #666;
        }
        
        button {
            padding: 10px 20px;
            background: #2a2a2a;
            border: 1px solid #333;
            color: #e0e0e0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        button:hover {
            background: #3a3a3a;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .small-btn {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .search-results {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .result-info {
            flex: 1;
            cursor: pointer;
        }
        
        .result-info:hover {
            color: #fff;
        }
        
        .result-title {
            font-size: 14px;
            margin-bottom: 3px;
        }
        
        .result-artist {
            font-size: 12px;
            color: #888;
        }
        
        .result-actions {
            display: flex;
            gap: 5px;
        }
        
        .player-section {
            background: #1a1a1a;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .now-playing {
            margin-bottom: 15px;
        }
        
        .track-info {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .track-artist {
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .loop-indicator {
            padding: 10px 20px;
            background: #2a2a2a;
            border: 1px solid #333;
            font-size: 14px;
        }
        
        .loop-indicator.active {
            background: #3a3a3a;
            border-color: #666;
        }
        
        .playlist-section {
            background: #1a1a1a;
            padding: 15px;
            border: 1px solid #333;
        }
        
        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .playlist-item {
            padding: 10px;
            border-bottom: 1px solid #2a2a2a;
            margin-bottom: 10px;
        }
        
        .playlist-name-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .playlist-name {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
        }
        
        .playlist-name:hover {
            color: #fff;
        }
        
        .track-list {
            margin-top: 10px;
            padding-left: 20px;
            font-size: 12px;
            color: #888;
        }
        
        .track-list-item {
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }
        
        .modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 20px;
            max-width: 400px;
            margin: 100px auto;
        }
        
        .modal-content h2 {
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: normal;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .status {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="version">v8.0</div>
    
    <div class="container">
        <h1>FOCUS MUSIC PLAYER</h1>
        
        <!-- Setup Instructions -->
        <div class="info-box" id="setupInstructions">
            FIRST-TIME SETUP:<br>
            You need to configure your Spotify Client ID. Edit this HTML file and replace YOUR_CLIENT_ID_HERE on line 379 with your actual Spotify Client ID.<br>
            <br>
            How to get Client ID:<br>
            1. Go to <a href="https://developer.spotify.com/dashboard" target="_blank" style="color: #888;">developer.spotify.com/dashboard</a><br>
            2. Create an app (name: anything)<br>
            3. Add Redirect URI: YOUR_GITHUB_PAGES_URL/callback.html<br>
            4. Copy Client ID and paste it in this file (line 379)<br>
            5. Save and refresh
        </div>
        
        <!-- Auth Section -->
        <div class="auth-section" id="authSection">
            <button id="loginBtn">Connect Spotify</button>
            <div id="authStatus" class="status">Not connected. Click above to login.</div>
        </div>
        
        <!-- Search Section -->
        <div class="search-section" id="searchSection" style="display: none;">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search: song name or artist">
                <button id="searchBtn">Search</button>
            </div>
            <div id="searchResults" class="search-results"></div>
            <div id="searchStatus" class="status">Ready to search.</div>
        </div>
        
        <!-- Player Section -->
        <div class="player-section" id="playerSection" style="display: none;">
            <div class="now-playing">
                <div class="track-info" id="nowPlayingTitle">No track loaded</div>
                <div class="track-artist" id="nowPlayingArtist"></div>
            </div>
            
            <div class="controls">
                <button id="playBtn" disabled>Play</button>
                <button id="pauseBtn" disabled>Pause</button>
                <button id="nextBtn" disabled>Next</button>
                <button id="loopBtn" class="loop-indicator">Loop: OFF</button>
            </div>
        </div>
        
        <!-- Playlist Section -->
        <div class="playlist-section" id="playlistSection" style="display: none;">
            <div class="playlist-header">
                <h2>PLAYLISTS (Saved Locally)</h2>
                <button id="newPlaylistBtn">New Playlist</button>
            </div>
            <div id="playlistContainer"></div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="newPlaylistModal" class="modal">
        <div class="modal-content">
            <h2>CREATE NEW PLAYLIST</h2>
            <input type="text" id="playlistNameInput" placeholder="Playlist name" style="width: 100%; margin-bottom: 10px;">
            <div class="modal-buttons">
                <button id="createPlaylistBtn">Create</button>
                <button id="cancelPlaylistBtn">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="addToPlaylistModal" class="modal">
        <div class="modal-content">
            <h2>ADD TO PLAYLIST</h2>
            <div id="playlistSelectContainer"></div>
            <div class="modal-buttons">
                <button id="cancelAddBtn">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        console.log('Focus Music Player v8.0 - Spotify Edition');
        
        // REPLACE THIS WITH YOUR SPOTIFY CLIENT ID
        const CLIENT_ID = 'YOUR_CLIENT_ID_HERE';
        const REDIRECT_URI = window.location.origin + '/callback.html';
        const SCOPES = 'streaming user-read-email user-read-private';
        
        // State
        let accessToken = localStorage.getItem('spotifyToken');
        let tokenExpiry = localStorage.getItem('spotifyTokenExpiry');
        let playlists = JSON.parse(localStorage.getItem('focusPlaylists') || '[]');
        let currentTrack = null;
        let currentPlaylist = null;
        let currentPlaylistIndex = -1;
        let loopMode = 'off';
        let player = null;
        let deviceId = null;
        
        // DOM elements
        const setupInstructions = document.getElementById('setupInstructions');
        const authSection = document.getElementById('authSection');
        const loginBtn = document.getElementById('loginBtn');
        const authStatus = document.getElementById('authStatus');
        const searchSection = document.getElementById('searchSection');
        const playerSection = document.getElementById('playerSection');
        const playlistSection = document.getElementById('playlistSection');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchResultsDiv = document.getElementById('searchResults');
        const searchStatus = document.getElementById('searchStatus');
        const nowPlayingTitle = document.getElementById('nowPlayingTitle');
        const nowPlayingArtist = document.getElementById('nowPlayingArtist');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const nextBtn = document.getElementById('nextBtn');
        const loopBtn = document.getElementById('loopBtn');
        const playlistContainer = document.getElementById('playlistContainer');
        const newPlaylistBtn = document.getElementById('newPlaylistBtn');
        const newPlaylistModal = document.getElementById('newPlaylistModal');
        const playlistNameInput = document.getElementById('playlistNameInput');
        const createPlaylistBtn = document.getElementById('createPlaylistBtn');
        const cancelPlaylistBtn = document.getElementById('cancelPlaylistBtn');
        const addToPlaylistModal = document.getElementById('addToPlaylistModal');
        const playlistSelectContainer = document.getElementById('playlistSelectContainer');
        const cancelAddBtn = document.getElementById('cancelAddBtn');
        
        // Check if client ID is set
        if (CLIENT_ID === 'YOUR_CLIENT_ID_HERE') {
            setupInstructions.style.display = 'block';
        } else {
            setupInstructions.style.display = 'none';
        }
        
        // Check for token in URL hash (returning from auth)
        const hash = window.location.hash.substring(1);
        if (hash) {
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            const expiresIn = params.get('expires_in');
            
            if (token) {
                accessToken = token;
                tokenExpiry = Date.now() + (parseInt(expiresIn) * 1000);
                localStorage.setItem('spotifyToken', accessToken);
                localStorage.setItem('spotifyTokenExpiry', tokenExpiry);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        // Check if token is valid
        if (accessToken && tokenExpiry && Date.now() < tokenExpiry) {
            initPlayer();
        }
        
        // Auth
        loginBtn.addEventListener('click', () => {
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
            window.location.href = authUrl;
        });
        
        // Initialize Spotify Player
        window.onSpotifyWebPlaybackSDKReady = () => {
            if (accessToken) {
                initPlayer();
            }
        };
        
        function initPlayer() {
            authSection.style.display = 'none';
            searchSection.style.display = 'block';
            playerSection.style.display = 'block';
            playlistSection.style.display = 'block';
            authStatus.textContent = 'Connected!';
            
            player = new Spotify.Player({
                name: 'Focus Music Player',
                getOAuthToken: cb => { cb(accessToken); },
                volume: 1.0
            });
            
            player.addListener('ready', ({ device_id }) => {
                deviceId = device_id;
                console.log('Player ready with device ID:', deviceId);
                searchStatus.textContent = 'Ready! Search for songs.';
            });
            
            player.addListener('not_ready', () => {
                searchStatus.textContent = 'Player disconnected. Refresh to reconnect.';
            });
            
            player.addListener('player_state_changed', (state) => {
                if (!state) return;
                
                const track = state.track_window.current_track;
                if (track && currentTrack) {
                    nowPlayingTitle.textContent = track.name;
                    nowPlayingArtist.textContent = track.artists.map(a => a.name).join(', ');
                }
                
                // Handle track end
                if (state.paused && state.position === 0 && state.duration > 0 && currentTrack) {
                    handleTrackEnd();
                }
            });
            
            player.connect();
            renderPlaylists();
        }
        
        function handleTrackEnd() {
            if (loopMode === 'single' && currentTrack) {
                playTrack(currentTrack);
            } else if (currentPlaylist && currentPlaylistIndex < currentPlaylist.tracks.length - 1) {
                playNext();
            } else if (loopMode === 'playlist' && currentPlaylist) {
                currentPlaylistIndex = 0;
                playTrack(currentPlaylist.tracks[0]);
            }
        }
        
        // Search
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });
        
        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query) return;
            
            searchStatus.textContent = 'Searching...';
            searchResultsDiv.innerHTML = '';
            
            try {
                const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=15`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                const data = await response.json();
                
                if (data.tracks && data.tracks.items.length > 0) {
                    displayResults(data.tracks.items);
                    searchStatus.textContent = `Found ${data.tracks.items.length} results`;
                } else {
                    searchStatus.textContent = 'No results found.';
                }
            } catch (error) {
                searchStatus.textContent = 'Search failed. Token may be expired.';
                console.error(error);
            }
        }
        
        function displayResults(tracks) {
            searchResultsDiv.innerHTML = '';
            
            tracks.forEach(track => {
                const div = document.createElement('div');
                div.className = 'result-item';
                
                const info = document.createElement('div');
                info.className = 'result-info';
                info.innerHTML = `
                    <div class="result-title">${escapeHtml(track.name)}</div>
                    <div class="result-artist">${escapeHtml(track.artists.map(a => a.name).join(', '))}</div>
                `;
                info.addEventListener('click', () => playTrack({
                    id: track.uri,
                    name: track.name,
                    artist: track.artists.map(a => a.name).join(', ')
                }));
                
                const actions = document.createElement('div');
                actions.className = 'result-actions';
                
                const addBtn = document.createElement('button');
                addBtn.className = 'small-btn';
                addBtn.textContent = '+ Playlist';
                addBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showAddToPlaylist({
                        id: track.uri,
                        name: track.name,
                        artist: track.artists.map(a => a.name).join(', ')
                    });
                });
                
                actions.appendChild(addBtn);
                div.appendChild(info);
                div.appendChild(actions);
                searchResultsDiv.appendChild(div);
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Playback
        async function playTrack(track) {
            if (!deviceId) {
                searchStatus.textContent = 'Player not ready. Wait a moment.';
                return;
            }
            
            currentTrack = track;
            
            try {
                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ uris: [track.id] }),
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                nowPlayingTitle.textContent = track.name;
                nowPlayingArtist.textContent = track.artist;
                
                playBtn.disabled = false;
                pauseBtn.disabled = false;
                nextBtn.disabled = false;
                
                searchStatus.textContent = 'Playing...';
            } catch (error) {
                searchStatus.textContent = 'Playback error. Try again.';
                console.error(error);
            }
        }
        
        playBtn.addEventListener('click', () => player && player.resume());
        pauseBtn.addEventListener('click', () => player && player.pause());
        nextBtn.addEventListener('click', playNext);
        
        loopBtn.addEventListener('click', () => {
            if (loopMode === 'off') {
                loopMode = 'single';
                loopBtn.textContent = 'Loop: SINGLE';
                loopBtn.classList.add('active');
            } else if (loopMode === 'single') {
                loopMode = 'playlist';
                loopBtn.textContent = 'Loop: PLAYLIST';
            } else {
                loopMode = 'off';
                loopBtn.textContent = 'Loop: OFF';
                loopBtn.classList.remove('active');
            }
        });
        
        function playNext() {
            if (!currentPlaylist) return;
            
            if (currentPlaylistIndex >= currentPlaylist.tracks.length - 1) {
                if (loopMode === 'playlist') {
                    currentPlaylistIndex = 0;
                    playTrack(currentPlaylist.tracks[0]);
                }
                return;
            }
            
            currentPlaylistIndex++;
            playTrack(currentPlaylist.tracks[currentPlaylistIndex]);
        }
        
        // Playlist management (same as before)
        newPlaylistBtn.addEventListener('click', () => {
            newPlaylistModal.style.display = 'block';
            playlistNameInput.value = '';
            playlistNameInput.focus();
        });
        
        cancelPlaylistBtn.addEventListener('click', () => {
            newPlaylistModal.style.display = 'none';
        });
        
        createPlaylistBtn.addEventListener('click', () => {
            const name = playlistNameInput.value.trim();
            if (!name) return;
            
            playlists.push({
                id: Date.now(),
                name: name,
                tracks: []
            });
            
            savePlaylists();
            renderPlaylists();
            newPlaylistModal.style.display = 'none';
        });
        
        playlistNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createPlaylistBtn.click();
        });
        
        function savePlaylists() {
            localStorage.setItem('focusPlaylists', JSON.stringify(playlists));
        }
        
        function renderPlaylists() {
            playlistContainer.innerHTML = '';
            
            if (playlists.length === 0) {
                playlistContainer.innerHTML = '<div style="color: #888; padding: 10px;">No playlists. Create one above.</div>';
                return;
            }
            
            playlists.forEach(playlist => {
                const div = document.createElement('div');
                div.className = 'playlist-item';
                
                const nameContainer = document.createElement('div');
                nameContainer.className = 'playlist-name-container';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'playlist-name';
                nameDiv.textContent = `${playlist.name} (${playlist.tracks.length} tracks)`;
                nameDiv.addEventListener('click', () => playPlaylist(playlist));
                
                const actions = document.createElement('div');
                actions.className = 'result-actions';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'small-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete "${playlist.name}"?`)) {
                        playlists = playlists.filter(p => p.id !== playlist.id);
                        savePlaylists();
                        renderPlaylists();
                    }
                });
                
                actions.appendChild(deleteBtn);
                nameContainer.appendChild(nameDiv);
                nameContainer.appendChild(actions);
                div.appendChild(nameContainer);
                
                if (playlist.tracks.length > 0) {
                    const trackList = document.createElement('div');
                    trackList.className = 'track-list';
                    playlist.tracks.forEach((track, idx) => {
                        const trackItem = document.createElement('div');
                        trackItem.className = 'track-list-item';
                        
                        const trackInfo = document.createElement('span');
                        trackInfo.textContent = `${idx + 1}. ${track.name}`;
                        trackInfo.style.cursor = 'pointer';
                        trackInfo.addEventListener('click', () => {
                            currentPlaylist = playlist;
                            currentPlaylistIndex = idx;
                            playTrack(track);
                        });
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'small-btn';
                        removeBtn.textContent = 'Remove';
                        removeBtn.addEventListener('click', () => {
                            playlist.tracks.splice(idx, 1);
                            savePlaylists();
                            renderPlaylists();
                        });
                        
                        trackItem.appendChild(trackInfo);
                        trackItem.appendChild(removeBtn);
                        trackList.appendChild(trackItem);
                    });
                    div.appendChild(trackList);
                }
                
                playlistContainer.appendChild(div);
            });
        }
        
        function playPlaylist(playlist) {
            if (playlist.tracks.length === 0) {
                alert('Playlist is empty');
                return;
            }
            
            currentPlaylist = playlist;
            currentPlaylistIndex = 0;
            playTrack(playlist.tracks[0]);
        }
        
        cancelAddBtn.addEventListener('click', () => {
            addToPlaylistModal.style.display = 'none';
        });
        
        function showAddToPlaylist(track) {
            playlistSelectContainer.innerHTML = '';
            
            if (playlists.length === 0) {
                playlistSelectContainer.innerHTML = '<p style="color: #888;">No playlists. Create one first.</p>';
            } else {
                playlists.forEach(playlist => {
                    const btn = document.createElement('button');
                    btn.textContent = playlist.name;
                    btn.style.width = '100%';
                    btn.style.marginBottom = '5px';
                    btn.addEventListener('click', () => {
                        const exists = playlist.tracks.some(t => t.id === track.id);
                        if (exists) {
                            alert('Already in playlist');
                            return;
                        }
                        
                        playlist.tracks.push(track);
                        savePlaylists();
                        renderPlaylists();
                        addToPlaylistModal.style.display = 'none';
                        searchStatus.textContent = `Added to "${playlist.name}"`;
                    });
                    playlistSelectContainer.appendChild(btn);
                });
            }
            
            addToPlaylistModal.style.display = 'block';
        }
        
        window.addEventListener('click', (e) => {
            if (e.target === newPlaylistModal) newPlaylistModal.style.display = 'none';
            if (e.target === addToPlaylistModal) addToPlaylistModal.style.display = 'none';
        });
    </script>
</body>
</html>
